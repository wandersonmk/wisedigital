import type { Session, User } from '@supabase/supabase-js'
import { translateError } from '~/utils/errorTranslations'

export function useAuth() {
  // Estados globais
  const user = useState<User | null>('auth_user', () => null)
  const session = useState<Session | null>('auth_session', () => null)
  const isLoading = useState<boolean>('auth_loading', () => true)
  const errorMessage = useState<string | null>('auth_error', () => null)

  // Computed property para verificar se está autenticado
  const isAuthenticated = computed(() => !!user.value)

  // Função para obter o cliente Supabase apenas no cliente
  const getSupabaseClient = () => {
    if (!process.client) {
      throw new Error('useSupabaseClient só pode ser usado no cliente')
    }
    return useSupabaseClient()
  }

  // Função para limpar erro
  const clearError = () => {
    errorMessage.value = null
  }

  // Função para recarregar sessão
  const reloadSession = async (): Promise<void> => {
    if (!process.client) return

    try {
      const supabase = getSupabaseClient()
      isLoading.value = true
      
      const { data, error } = await supabase.auth.getSession()
      
      if (error) {
        console.error('Erro ao recarregar sessão:', error)
        user.value = null
        session.value = null
        return
      }

      session.value = data.session
      user.value = data.session?.user || null
      
    } catch (err) {
      console.error('Erro inesperado ao recarregar sessão:', err)
      user.value = null
      session.value = null
    } finally {
      isLoading.value = false
    }
  }

  // Função de login
  const signInWithEmailAndPassword = async (email: string, password: string): Promise<boolean> => {
    if (!process.client) {
      throw new Error('Login só pode ser feito no cliente')
    }

    try {
      const supabase = getSupabaseClient()
      isLoading.value = true
      clearError()

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      })

      if (error) {
        console.error('Erro de login:', error)
        const translatedError = translateError(error.message)
        errorMessage.value = translatedError
        return false
      }

      session.value = data.session
      user.value = data.user
      
      console.log('Login realizado com sucesso!')
      return true

    } catch (err) {
      console.error('Erro inesperado no login:', err)
      const translatedError = translateError('An unexpected error occurred')
      errorMessage.value = translatedError
      return false
    } finally {
      isLoading.value = false
    }
  }

  // Função de registro
  const signUp = async (email: string, password: string, nome: string, nomeEmpresa: string): Promise<boolean> => {
    if (!process.client) {
      throw new Error('Registro só pode ser feito no cliente')
    }

    try {
      const supabase = getSupabaseClient()
      isLoading.value = true
      clearError()

      // 1. Criar usuário no auth
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            nome: nome
          }
        }
      })

      if (authError) {
        console.error('Erro ao criar usuário:', authError)
        const translatedError = translateError(authError.message)
        errorMessage.value = translatedError
        return false
      }

      if (!authData.user) {
        errorMessage.value = 'Erro ao criar usuário'
        return false
      }

      // 2. Criar registro na tabela usuarios
      const { data: userRecord, error: userError } = await supabase
        .from('usuarios')
        .insert({
          id: authData.user.id,
          nome: nome,
          email: email,
          perfil: 'admin'
        })
        .select()
        .single()

      if (userError) {
        console.error('Erro ao criar registro do usuário:', userError)
        errorMessage.value = 'Erro ao salvar dados do usuário'
        return false
      }

      // 3. Criar empresa
      const { error: companyError } = await supabase
        .from('empresas')
        .insert({
          usuario_id: authData.user.id,
          nome: nomeEmpresa,
          hora_abertura: '08:00:00',
          hora_fechamento: '18:00:00'
        })

      if (companyError) {
        console.error('Erro ao criar empresa:', companyError)
        errorMessage.value = 'Erro ao criar empresa'
        return false
      }

      session.value = authData.session
      user.value = authData.user
      
      console.log('Registro realizado com sucesso!')
      return true

    } catch (err) {
      console.error('Erro inesperado no registro:', err)
      errorMessage.value = 'Erro inesperado no registro'
      return false
    } finally {
      isLoading.value = false
    }
  }

  // Função de logout
  const signOut = async (): Promise<void> => {
    if (!process.client) return

    try {
      const supabase = getSupabaseClient()
      
      const { error } = await supabase.auth.signOut()
      
      if (error) {
        console.error('Erro no logout:', error)
      }
      
      // Limpar estado local
      user.value = null
      session.value = null
      errorMessage.value = null
      
      console.log('Logout realizado com sucesso!')
      
      // Redirecionar para login
      await navigateTo('/login')
      
    } catch (err) {
      console.error('Erro inesperado no logout:', err)
    }
  }

  // Inicializar no cliente
  if (process.client) {
    onMounted(async () => {
      await reloadSession()
      
      // Configurar listener de mudanças de auth
      const supabase = getSupabaseClient()
      supabase.auth.onAuthStateChange((event, newSession) => {
        console.log('Auth state changed:', event)
        session.value = newSession
        user.value = newSession?.user || null
        
        if (event === 'SIGNED_OUT') {
          navigateTo('/login')
        }
      })
    })
  }

  return {
    user: readonly(user),
    session: readonly(session),
    isAuthenticated: readonly(isAuthenticated),
    isLoading: readonly(isLoading),
    errorMessage: readonly(errorMessage),
    signInWithEmailAndPassword,
    signUp,
    signOut,
    reloadSession,
    clearError
  }
}

  // Usar estados globais que são inicializados pelo plugin
  const user = useState<User | null>('auth_user', () => null)
  const session = useState<Session | null>('auth_session', () => null)
  const isLoading = useState<boolean>('auth_loading', () => false)
  const errorMessage = useState<string | null>('auth_error', () => null)

  async function loadSession() {
    try {
      isLoading.value = true
      const { data, error } = await supabase.auth.getSession()
      if (error) {
        errorMessage.value = error.message
        session.value = null
        user.value = null
        return
      }
      session.value = data.session
      user.value = data.session?.user ?? null
    } catch (error) {
      console.error('Erro ao carregar sessão:', error)
      session.value = null
      user.value = null
    } finally {
      isLoading.value = false
    }
  }

  const isAuthenticated = computed(() => {
    // Força reatividade verificando ambos os valores
    const hasUser = Boolean(user.value)
    const hasSession = Boolean(session.value)
    return hasUser && hasSession
  })

  async function signInWithEmailAndPassword(email: string, password: string) {
    errorMessage.value = null
    isLoading.value = true
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      })
      if (error) throw error
      
      // Atualizar estado local imediatamente
      if (data.session && data.user) {
        console.log('useAuth: Atualizando estado local após login')
        user.value = data.user
        session.value = data.session
        console.log('useAuth: Estado local atualizado:', { 
          hasUser: !!user.value, 
          hasSession: !!session.value,
          email: user.value?.email 
        })
      }
      
      return data
    } catch (err: any) {
      const translatedError = translateError(err?.message ?? 'Erro ao autenticar')
      errorMessage.value = translatedError
      throw err
    } finally {
      isLoading.value = false
    }
  }

  async function signUp(userData: {
    name: string
    companyName: string
    email: string
    password: string
  }) {
    errorMessage.value = null
    isLoading.value = true
    try {
      // 1. Criar usuário no Supabase Auth
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email: userData.email,
        password: userData.password
      })

      if (authError) throw authError

      if (!authData.user) {
        throw new Error('Falha ao criar usuário')
      }

      // 2. Inserir na tabela usuarios
      const { data: userRecord, error: userError } = await supabase
        .from('usuarios')
        .insert({
          id: authData.user.id, // Usar o mesmo ID do auth
          nome: userData.name,
          email: userData.email,
          perfil: 'admin' // O primeiro usuário da empresa é admin
        })
        .select()
        .single()

      if (userError) throw userError

      // 3. Inserir na tabela empresas
      const { error: companyError } = await supabase
        .from('empresas')
        .insert({
          usuario_id: authData.user.id,
          nome: userData.companyName,
          hora_abertura: '08:00:00', // Horário padrão
          hora_fechamento: '18:00:00' // Horário padrão
        })

      if (companyError) throw companyError

      return authData
    } catch (err: any) {
      const translatedError = translateError(err?.message ?? 'Erro ao criar conta')
      errorMessage.value = translatedError
      throw err
    } finally {
      isLoading.value = false
    }
  }

  async function signOut() {
    errorMessage.value = null
    isLoading.value = true
    try {
      const { error } = await supabase.auth.signOut()
      if (error) throw error
      
      // Limpar estado local
      user.value = null
      session.value = null
    } catch (err: any) {
      errorMessage.value = err?.message ?? 'Erro ao sair'
      throw err
    } finally {
      isLoading.value = false
    }
  }

  return {
    // state
    user,
    session,
    isAuthenticated,
    isLoading,
    errorMessage,

    // actions
    signInWithEmailAndPassword,
    signUp,
    signOut,

    // helpers
    reloadSession: loadSession,
  }
}


